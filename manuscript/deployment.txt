# Deployment

## Introduction

## Setting up the cluster

### Creating the cluster

We can create the cluster using one simple command. The only parameter
that we need is the cluster name.

{linenos=off}
	aws ecs create-cluster --cluster-name "searchapp"

Output:

{linenos=off}
	{
	    "cluster": {
		"status": "ACTIVE",
		"clusterName": "searchapp",
		"registeredContainerInstancesCount": 0,
		"pendingTasksCount": 0,
		"runningTasksCount": 0,
		"activeServicesCount": 0,
		"clusterArn": "arn:aws:ecs:us-east-1:387705308362:cluster/searchapp"
	    }
	}

AS you can see, the cluster was created successfully, it has zero EC2 container
instances registered, zero task running and no services.

The idea behind the ECS cluster is that you can forget about where and how you're
task and services will be deployed. You just have to launch them and Amazon
will take care of assigning the service or task to an instance. The only thing
that we have to take care for now is adding some EC2 instances to the cluster.

### Launching the EC2 instances

Now that we have our cluster, we can launch some instances and register them
in our cluster. For launching the instances we'll need:

- A Key Pair for ssh access
- A Security Group

Let's create our key pair:

{linenos=off}
	aws ec2 create-key-pair --key-name keys_cluster

Output:
{linenos=off}
	{
	    "KeyMaterial": "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAoB4e1mRD+c31WuYfGdbS8YmBn/yoD5T3RCACdkhNsk0XTOfSQrs0x\nq2svj16JIWLo0hYgI/4r0R8s8tpyK7WKWEdx83ElIyc+2kQqvMngD4j5oOvaXJzh4/vRYlVBrP6j\npkPmFc2CMadW96IIsdWHNL9oKnFM/dtmp81k/wqhce5q4YHYNXN93jQCnCcUZ3cSqmVatcJ9BdHm\nz7kD/NeZEapLbK1qnn3IM4vs9q27R2UMd1T1MlAT4lU0fPdxXNWG+5BItweq/2kk5Qv76fTwch5J\nbU7R+Y3Dxl25XwDU5KWnP9eUbvwDNXKHS/uKUUe5lN407NYkS41HWQIDAQABAoIBAQCXyBW5a/CY\nI+n60fwXdXIfbxcGvu3dX3wL8Cr0lEcAfz02RK2Tp9g0ryZb3b3A3mmGQbpCgM1tIXY0SGPm5+On\nDvZ9gqjzSD6348Ctky1coJPWxJN2hoUES6+CbWEgyfxRd7o7MGOXX/QDJP3O7e9d7SbK1TxG/07S\nNPckCdBFLcez37LNk2KZF7Es1DYllDWUvBHCC1iRB1XK52d3RcLhRMypSEU3cx/sxvpZ2SXqdYaR\nhvuXzbJi9eF1lq5i/uoxR3QtdX3Xga7DbNNhHSqV1FNCH7HhElrRRuN7aDh1DJSiSJDjrWR1GV5f\nNKFmprZq+wOaqg5IerdCYRwCxbuRAoGBAOMr7mcHQD9afBUTpF8oUiHivCN/RIIodr2ArkF69Ovs\nUFQrc7qL3sVfb56fVEhUG4r1g60bx7LXgFGVOfz/C5v6RV/J68heOfqJSIoeLi1M+Wb21tdrrIP4\nvD9pI/Otp4L8Dniwk3fox2MuDoUqd1fpeA7bE/OePxddbDlFIWzdAoGBALRv0unhUcD64jt0f3/a\nca2XJ8VtxTbkgiplDTvsQW4oPzhg3rGQBGJL7iz6i3qbryl1sjMQaI8HxDylq08mQIu9Vs0L7YBe\n/hZ6eeaswTnJBeXbtkjKGX1HPNAgY3evbmTGKRt+ombHPhEE2gYHnkMxxIzbTCCCjIpSfMCWEy6t\nAoGARamWHPADSqozvL7eO/QAY7XE3dnMJ2HDL8+DID9VVfeMlpMQlRcJRFtEvk67qMZp/83UCESp\nk3U0O1BYjPWlGLrBhWNFM5d5jhOFNB2XKXseS+3L6hlxuLKQ/5z9Ul9hK/Che28iebXfVtGr0Dg6\nirHkiCG0V5OiY0bZxiIl4t0CgYByL7on7EGSgLKesZDmVlVOZ7PxixAdNurw7VY8r7yQe8PWZ+dG\nMz+y/R5TNJMEGnX1JNiK3D1vFpknUChjRG/gfwfpZzz72iGuFAAE7Rqy+PZUioCG++65i1V+2KBZ\n45lXCNiG39LifABZQNrAqh2LpHkgMr+way2Jc74jGlY1WQKBgQCNH0rPNyk/NH5JHNazV5Rk0Ot+\nm+xs3Fo4YueKWN9fw17g8gN2oMT59eNFnT0OBIXvRtSoGLSBrqlS3DhPYjSZIjIarpPph8MDPKtl\ns/4EogOKf8MpaGAolvqTNFaWDmu3w1BXzkI9vC/tghBPXPnQRH2JkW4xOd9Mv59DgwGo/w==\n-----END RSA PRIVATE KEY-----",
	    "KeyName": "keys_cluster",
	    "KeyFingerprint": "69:90:35:93:a8:db:fe:d0:77:00:82:35:b6:84:2a:98:6d:43:30:b5"
	}

Create a file named key_cluster.pem and paste the entire key (the value of the KeyMaterial key).
Don't forget the lines:

{linenos=off}
	"----BEGIN RSA PRIVATE KEY----"
	"-----END RSA PRIVATE KEY-----" 

Now set the permissions of the file:

{linenos=off}
	$ chmod 400 cluster.pem

Now move the file to your ssh keys directory or some place safe. Remember
that with just this file you'll be able to ssh into your cluster instances.

Now, let's create the security group. The rules for this security group
are going to restrict and allow access to our cluster instances.

Some time ago Amazon released their VPC technology and now you'll probably
have a default vpc. We're going to need the id of the vpc in order to create
resources inside of if.

The command for getting your default VPC attributes is:

{linenos=off}
	aws ec2 describe-vpcs

Output:
{linenos=off}
	{
	    "Vpcs": [
		{
		    "VpcId": "vpc-120cd476",
		    "InstanceTenancy": "default",
		    "State": "available",
		    "DhcpOptionsId": "dopt-5bf9023e",
		    "CidrBlock": "172.31.0.0/16",
		    "IsDefault": true
		}
	    ]
	}

As you can see my vpc id is vpc-120cd476 and the IsDefault key has the value
true so it's my default vpc.

Now that we have this info, let's create the security group. Just replace the 
vpc-id parameter with yours.

{linenos=off}
	aws ec2 create-security-group --group-name cluster-sg --description "Searchapp cluster security group" --vpc-id vpc-120cd476

Output:
{linenos=off}
	{
	    "GroupId": "sg-1b0af77d"
	}

And now let's add authorization for ssh access. Replace the group-id with the id
returned in the previous command, and the cidr with your vpc cidr (output from describe-vpcs):

{linenos=off}
	aws ec2 authorize-security-group-ingress --group-id sg-1b0af77d --protocol tcp --port 22 --cidr 172.31.0.0/16

This command doesn't produce any output.

